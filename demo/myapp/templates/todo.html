{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
<!-- Add Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Mapbox Scripts -->
<script src='https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.css' rel='stylesheet' />
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Todo Form -->
    <form method="POST" action="{% url 'add_todo' %}" class="mb-8 bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
        {% csrf_token %}
        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="title">
                Title
            </label>
            <input type="text" name="title" id="title" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="description">
                Description
            </label>
            <textarea name="description" id="description" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
        </div>
        <!-- Location Fields -->
        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="location">
                Location
            </label>
            <div id="map" class="w-full aspect-[16/9] rounded-lg overflow-hidden shadow-md"></div>
            <input type="text" id="location_name" name="location_name" class="mt-3 shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Location name">
            <input type="hidden" id="latitude" name="latitude">
            <input type="hidden" id="longitude" name="longitude">
        </div>
        <div class="flex justify-end">
            <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                Add Todo
            </button>
        </div>
    </form>

    <!-- Todo List -->
    <div class="bg-white shadow-md rounded px-8 pt-6 pb-8">
        <h2 class="text-2xl font-bold mb-4">Your Todos</h2>
        {% for todo in todos %}
        <div class="flex items-center justify-between border-b py-4">
            <div class="flex-1 cursor-pointer" onclick="showTodoDetails('{{ todo.id }}', '{{ todo.title }}', '{{ todo.description }}', '{{ todo.location_name }}', '{{ todo.latitude }}', '{{ todo.longitude }}')">
                <h3 class="text-lg font-semibold {% if todo.completed %}line-through text-gray-500{% endif %}">
                    {{ todo.title }}
                </h3>
                {% if todo.description %}
                <p class="text-gray-600">{{ todo.description }}</p>
                {% endif %}
                {% if todo.location_name %}
                <p class="text-sm text-gray-500">üìç {{ todo.location_name }}</p>
                {% endif %}
            </div>
            <div class="flex space-x-2">
                <form method="POST" action="{% url 'toggle_todo' todo.id %}">
                    {% csrf_token %}
                    <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-2 rounded">
                        {% if todo.completed %}Undo{% else %}Complete{% endif %}
                    </button>
                </form>
                <form method="POST" action="{% url 'delete_todo' todo.id %}">
                    {% csrf_token %}
                    <button type="submit" class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded">
                        Delete
                    </button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Todo Details Modal -->
<div id="todoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 id="modalTitle" class="text-2xl font-bold leading-6 text-gray-900 mb-2"></h3>
            <p id="modalDescription" class="text-gray-600 mb-4"></p>
            <div id="modalLocation" class="text-sm text-gray-500 mb-2"></div>
            <div id="detailMap" class="w-full aspect-[16/9] rounded-lg overflow-hidden shadow-md mb-4"></div>
            <div class="flex justify-end">
                <button onclick="closeModal()" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
mapboxgl.accessToken = '{{ mapbox_token }}';

// Initialize the main map with UNSW as the default center
const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [151.2500, -33.9189], // Coordinates for UNSW
    zoom: 14,
    attributionControl: true
});

// Add navigation controls to the main map
map.addControl(new mapboxgl.NavigationControl(), 'top-right');

// Initialize the Mapbox Geocoder control with supported types only
const geocoder = new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    mapboxgl: mapboxgl,
    marker: false,
    placeholder: 'Search for a location',
    countries: 'au', // Focus on Australia
    language: 'en',
    types: 'poi.landmark,poi,address,place'
});

map.addControl(geocoder);

// Store the current marker reference
let currentMarker = null;

// Function to fetch locations based on user input
function fetchLocations(query) {
    fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${query}.json?types=poi,address,place&access_token=${mapboxgl.accessToken}`)
        .then(response => response.json())
        .then(data => {
            console.log(data.features); // Log the features to the console
            // You can also handle the results here, e.g., display them in a dropdown
        })
        .catch(error => console.error('Error fetching locations:', error));
}

// Update the hidden fields when a location is selected via the geocoder
geocoder.on('result', function(e) {
    // Remove existing marker if it exists
    if (currentMarker) {
        currentMarker.remove();
    }

    // Set the new location values
    document.getElementById('location_name').value = e.result.place_name;
    document.getElementById('latitude').value = e.result.center[1];
    document.getElementById('longitude').value = e.result.center[0];

    // Add a new marker at the selected location
    currentMarker = new mapboxgl.Marker({ draggable: true }) // Make the marker draggable
        .setLngLat(e.result.center)
        .addTo(map);

    // Clear the Mapbox Geocoder input when the marker is moved
    currentMarker.on('dragend', function() {
        const lngLat = currentMarker.getLngLat();
        reverseGeocode(lngLat.lng, lngLat.lat); // Update the location name based on the new position

        // Clear the Mapbox Geocoder input
        const geocoderInput = document.querySelector('.mapboxgl-ctrl-geocoder--input');
        if (geocoderInput) {
            geocoderInput.value = ''; // Clear the input field
        }
    });
});

// Allow users to click on the map to set a location
map.on('click', function(e) {
    const lngLat = e.lngLat;
    const [lng, lat] = [lngLat.lng, lngLat.lat];

    // Update input fields with clicked location
    document.getElementById('latitude').value = lat;
    document.getElementById('longitude').value = lng;

    // Perform reverse geocoding to get the address
    reverseGeocode(lng, lat);

    // Remove existing marker if it exists
    if (currentMarker) {
        currentMarker.remove();
    }

    // Add a new marker at the clicked location
    currentMarker = new mapboxgl.Marker({ draggable: true }) // Make the marker draggable
        .setLngLat([lng, lat])
        .addTo(map);

    // Clear the Mapbox Geocoder input when the marker is moved
    currentMarker.on('dragend', function() {
        const lngLat = currentMarker.getLngLat();
        reverseGeocode(lngLat.lng, lngLat.lat); // Update the location name based on the new position

        // Clear the Mapbox Geocoder input
        const geocoderInput = document.querySelector('.mapboxgl-ctrl-geocoder--input');
        if (geocoderInput) {
            geocoderInput.value = ''; // Clear the input field
        }
    });

    // Clear the Mapbox Geocoder input when the map is clicked
    const geocoderInput = document.querySelector('.mapboxgl-ctrl-geocoder--input');
    if (geocoderInput) {
        geocoderInput.value = ''; // Clear the input field
    }
});

// Example usage of fetchLocations function
// Call this function when you want to search for a landmark
// fetchLocations('sydney opera house'); // Uncomment to test

// Function to perform reverse geocoding
async function reverseGeocode(lng, lat) {
    try {
        const response = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token={{ mapbox_token }}&limit=1`);
        const data = await response.json();
        if (data.features.length > 0) {
            document.getElementById('location_name').value = data.features[0].place_name; // Update the location name
        }
    } catch (error) {
        console.error("Error getting address:", error);
    }
}

let detailMap = null;

function showTodoDetails(id, title, description, location, lat, lng) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalDescription').textContent = description || 'No description';
    document.getElementById('modalLocation').textContent = location ? `üìç ${location}` : 'No location set';
    document.getElementById('todoModal').classList.remove('hidden');
    document.getElementById('detailMap').style.display = lat && lng ? 'block' : 'none';

    // Initialize or update the detail map if a valid location exists
    if (lat && lng) {
        if (!detailMap) {
            detailMap = new mapboxgl.Map({
                container: 'detailMap',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [lng, lat],
                zoom: 14,
                attributionControl: true
            });
            detailMap.addControl(new mapboxgl.NavigationControl(), 'top-right');
        } else {
            detailMap.setCenter([lng, lat]);
            detailMap.setZoom(14);
        }

        // Remove any previous markers on the detail map and add a new one
        document.querySelectorAll('#detailMap .mapboxgl-marker').forEach(marker => marker.remove());
        new mapboxgl.Marker()
            .setLngLat([lng, lat])
            .addTo(detailMap);
    }
}

// Resize maps when the window is resized
window.addEventListener('resize', () => {
    map.resize();
    if (detailMap) {
        detailMap.resize();
    }
});

function closeModal() {
    document.getElementById('todoModal').classList.add('hidden');
}

// Close modal when clicking outside of it
window.onclick = function(event) {
    const modal = document.getElementById('todoModal');
    if (event.target == modal) {
        closeModal();
    }
}
</script>
{% endblock %}